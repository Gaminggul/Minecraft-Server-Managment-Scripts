#!/usr/bin/env bash

# Minecraft Server Setup Script (mc-new)
# Creates a new Minecraft server folder with selected software and version.
# Usage: mc-new
# Author: Noel Janzen
# 30.12.2025

set -euo pipefail

BASE_DIR="YOUR_MINECRAFT_BASE_DIR" # <-- EDIT!

need() { command -v "$1" >/dev/null 2>&1 || {
  echo "Missing: $1"
  exit 1
}; }
need curl
need java
need jq

echo "=== Minecraft Server Wizard (mc-new) ==="
echo

read -rp "Server-Name (Foldername, e.g. myserver_1.21.4): " NAME
if [[ -z "${NAME// /}" ]]; then
  echo "Name can't be empty."
  exit 1
fi

DIR="${BASE_DIR}/${NAME}"
if [[ -e "$DIR" ]]; then
  echo "Folder already exists: $DIR"
  exit 1
fi

mkdir -p "$DIR"
cleanup() {
  # only delete if still empty/semi-finished and not explicitly kept
  if [[ -d "$DIR" ]]; then
    echo "Cleanup: delete incomplete folder $DIR"
    rm -rf "$DIR"
  fi
}
trap cleanup ERR

cd "$DIR"

# EULA set directly
echo "eula=true" >eula.txt

echo
echo "Software auswählen:"
echo "  1) Vanilla"
echo "  2) Paper"
echo "  3) Purpur"
echo "  4) Forge"
read -rp "Auswahl (1-4): " FLAVOR

echo
read -rp "Minecraft Version (e.g. 1.21.4): " MCVER
if [[ -z "${MCVER// /}" ]]; then
  echo "Version can't be empty."
  exit 1
fi

download_vanilla() {
  local verjson url
  verjson="$(curl -fsSL https://piston-meta.mojang.com/mc/game/version_manifest_v2.json |
    jq -r --arg v "$MCVER" '.versions[] | select(.id==$v) | .url' | head -n1)"

  if [[ -z "$verjson" || "$verjson" == "null" ]]; then
    echo "Could not find Vanilla-Version ${MCVER} in Manifest."
    exit 1
  fi

  url="$(curl -fsSL "$verjson" | jq -r '.downloads.server.url')"
  if [[ -z "$url" || "$url" == "null" ]]; then
    echo "Could not find server.jar URL for ${MCVER}."
    exit 1
  fi

  curl -fL "$url" -o server.jar
}

download_paper() {
  local latest url
  latest="$(curl -fsSL "https://api.papermc.io/v2/projects/paper/versions/${MCVER}" |
    jq -r '.builds[-1]')"

  if [[ -z "$latest" || "$latest" == "null" ]]; then
    echo "No Paper-Builds found for ${MCVER}."
    exit 1
  fi

  url="https://api.papermc.io/v2/projects/paper/versions/${MCVER}/builds/${latest}/downloads/paper-${MCVER}-${latest}.jar"
  curl -fL "$url" -o server.jar
}

download_purpur() {
  local url
  url="https://api.purpurmc.org/v2/purpur/${MCVER}/latest/download"
  curl -fL "$url" -o server.jar
}

install_forge() {
  echo
  echo "Forge needs a exact Forge-Version."
  echo "Example (Format): 1.20.1-47.2.20"
  read -rp "Forge Version (e.g. 1.20.1-47.2.20): " FORGEVER
  if [[ -z "${FORGEVER// /}" ]]; then
    echo "Forge Version can't be empty."
    exit 1
  fi

  # Forge Installer URL (Maven Repo)
  local installer_url="https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGEVER}/forge-${FORGEVER}-installer.jar"
  echo "Loading Forge Installer: $installer_url"
  curl -fL "$installer_url" -o forge-installer.jar

  echo "Installing Forge Server..."
  # Forge installs installs the Server into folder
  java -jar forge-installer.jar --installServer

  # Cleanup Installer
  rm -f forge-installer.jar forge-installer.jar.log 2>/dev/null || true

  # Rename the generated forge-*.jar to server.jar (symlink)
  local candidate=""
  candidate="$(ls -1 forge-*-server.jar 2>/dev/null | head -n1 || true)"
  if [[ -z "$candidate" ]]; then
    candidate="$(ls -1 forge-*.jar 2>/dev/null | grep -v 'installer' | head -n1 || true)"
  fi

  if [[ -z "$candidate" ]]; then
    echo "Forge installed, but no Forge-Server-JAR found, on which I can link server.jar."
    echo "Please check the folder contents. (For some Forge versions, you start via a generated run.sh)"
    exit 1
  fi

  rm -f server.jar
  ln -s "$candidate" server.jar
  echo "Forge OK: server.jar -> $candidate"
}

echo
echo "Setup is running ..."

case "$FLAVOR" in
1) download_vanilla ;;
2) download_paper ;;
3) download_purpur ;;
4) install_forge ;;
*)
  echo "Invalid selection."
  exit 1
  ;;
esac

# Optional: server.properties minimal
if [[ ! -f server.properties ]]; then
  cat >server.properties <<'EOF'
motd=A Minecraft Server
enable-command-block=false
spawn-protection=16
max-players=20
online-mode=true
view-distance=32
simulation-distance=10
enable-rcon=false
EOF
fi

# run.sh (for manual start)
cat >run.sh <<EOF
#!/bin/bash
cd "$(pwd)"
exec java -Xms4G -Xmx12G -jar server.jar nogui
EOF
chmod +x run.sh

# Disable ERR trap for final messages
trap - ERR

echo
echo "✅ Finished!"
echo "Folder: $DIR"
echo "Jar:    $DIR/server.jar"
echo
echo "Start (manuel):"
echo "  cd \"$DIR\" && ./run.sh"
echo
echo "Or with the other tool:"
echo "  mc start \"$NAME\""
echo

read -rp "Should I start the server now? (y/N): " STARTNOW
if [[ "${STARTNOW,,}" == "y" ]]; then
  echo "Starting via mc ..."
  mc start "$NAME"
  echo "Attach:"
  echo "  mc attach \"$NAME\""
fi
